<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Register</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; }
        body { background: linear-gradient(to bottom right, #2b5876, #4e4376); color:white; min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:20px 0; }
        header { background: linear-gradient(90deg,#0072ff,#00c6ff); padding:12px 0; box-shadow:0 4px 15px rgba(0,0,0,0.3); position:sticky; top:0; width:100%; display:flex; justify-content:center; align-items:center; }
        nav { display:flex; gap:28px; font-weight:700; font-size:1.1rem; max-width:700px; width:100%; justify-content:center; align-items:center; }
        nav a { color:white; text-decoration:none; padding:10px 20px; border-radius:30px; transition:background-color 0.3s ease, transform 0.2s ease; }
        nav a:hover { background-color: rgba(255,255,255,0.3); transform: scale(1.1); }
        nav a.active { background-color:white; color:#0072ff; cursor:default; box-shadow:0 0 8px #00c6ffaa; transform: scale(1.15); }
        .container { background: rgba(255,255,255,0.05); border-radius:20px; padding:30px; width:90%; max-width:500px; backdrop-filter: blur(10px); box-shadow:0 8px 32px rgba(0,0,0,0.3); margin-top:30px; text-align:center; }
        input { width:100%; padding:12px; font-size:16px; margin-bottom:15px; border-radius:12px; border:none; outline:none; }
        h1, h2 { color:#00c6ff; margin-bottom:20px; }
        button { margin-top:10px; padding:14px 28px; border:none; border-radius:12px; background: linear-gradient(to right,#0072ff,#00c6ff); color:white; font-weight:700; font-size:1.1rem; cursor:pointer; transition:background-color 0.3s ease; }
        button:hover { background: linear-gradient(to right,#00c6ff,#0072ff); }
        .hidden { display:none; }
        #message { margin-top:15px; color:#ffdd57; }
    </style>
</head>
<body>
<header>
    <nav>
        <a href="/" >Home</a>
        <a href="/login">Login</a>
        <a href="/register" class="active">Create Account</a>
    </nav>
</header>

<main class="container">
    <h2>Register</h2>

    <form id="registerForm" th:action="@{/register}" th:object="${user}" method="post">
        <p><input type="text" th:field="*{username}" placeholder="Username" required autofocus /></p>
        <p><input type="tel" th:field="*{phoneNumber}" placeholder="+919876543210" required /></p>
        <p><input type="text" th:field="*{sid}" placeholder="Twilio Account SID" required /></p>
        <p><input type="text" th:field="*{auth}" placeholder="Twilio Auth Token" required /></p>
        <p><input type="password" th:field="*{password}" placeholder="Password" required /></p>
        <button type="submit">Register & Send OTP</button>
    </form>

    <form id="otpForm" class="hidden">
        <p><input type="text" id="otp" name="otp" placeholder="Enter OTP" pattern="\d{6}" required /></p>
        <button type="submit">Verify OTP</button>
    </form>

    <div id="message"></div>
</main>

<script>
    const registerForm = document.getElementById('registerForm');
    const otpForm = document.getElementById('otpForm');
    const messageDiv = document.getElementById('message');

    registerForm?.addEventListener('submit', async e => {
        e.preventDefault();
        const phone = document.querySelector("#phoneNumber").value.trim();
        const sid = document.querySelector("#sid").value.trim();
        const auth = document.querySelector("#auth").value.trim();
        const res = await fetch(`/otp/generate?phoneNumber=${encodeURIComponent(phone)}&sid=${encodeURIComponent(sid)}&auth=${encodeURIComponent(auth)}`);
        messageDiv.innerText = await res.text();

        registerForm.classList.add('hidden');
        otpForm.classList.remove('hidden');
    });

    otpForm?.addEventListener('submit', async e => {
        e.preventDefault();
        const otp = document.getElementById('otp').value.trim();
        //const phone = document.querySelector('#phoneNumber').value.trim();

        //const res = await fetch(`/otp/verify?phone=${encodeURIComponent(phone)}&otp=${encodeURIComponent(otp)}`, { method:'POST' });
        const res = await fetch(`/otp/checker?otp=${encodeURIComponent(otp)}`, { method:'POST' });
        messageDiv.innerText = await res.text();
        if (messageDiv.innerText == "true") {
            // Collect values from the registration form
            const username = document.querySelector("#username").value.trim();
            const password = document.querySelector("#password").value.trim();
            const phoneNumber = document.querySelector("#phoneNumber").value.trim();
            const sid = document.querySelector("#sid").value.trim();
            const auth = document.querySelector("#auth").value.trim();

            try {
                const res = await fetch("/register", {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        phoneNumber: phoneNumber,
                        sid: sid,
                        auth: auth
                    })
                });

                const msg = await res.text();
                messageDiv.innerText = msg;

                // Hide OTP form and registration form
                otpForm.classList.add('hidden');
                registerForm.classList.add('hidden');

                // Optionally show a final success message
                if (res.ok) {
                    messageDiv.innerText = "Registration successful! You can now log in.";
                } else {
                    messageDiv.innerText = "Registration failed: " + msg;
                }

            } catch (err) {
                messageDiv.innerText = "Registration failed: " + err;
            }
        }

    });
</script>
</body>
</html>
