<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Register</title>
    <link th:href="@{/default-ui.css}" rel="stylesheet" />
</head>
<body>
<div class="content">
    <!-- Step 1: Registration Form -->
    <form id="registerForm" class="login-form">
        <h2>Register</h2>

        <p>
            <input type="text" id="username" name="username" placeholder="Username" required autofocus
                   style="width:100%; padding:12px; font-size:16px; box-sizing:border-box;" />
        </p>

        <p>
            <input type="tel" id="phone_number" name="phoneNumber"
                   placeholder="+919876543210"
                   pattern="^\+?[1-9]\d{1,14}$"
                   title="Enter phone number with country code"
                   required
                   style="width:100%; padding:12px; font-size:16px; box-sizing:border-box;" />
        </p>

        <p>
            <input type="text" id="account_sid" name="sid" placeholder="Account SID from Twilio" required
                   style="width:100%; padding:12px; font-size:16px; box-sizing :border-box;" />
        </p>

        <p>
            <input type="text" id="auth_token" name="auth" placeholder="Auth Token Twilio" required
                   style="width:100%; padding:12px; font-size:16px; box-sizing:border-box;" />
        </p>

        <p>
            <input type="password" id="password" name="password" placeholder="Password" required
                   style="width:100%; padding:12px; font-size:16px; box-sizing:border-box;" />
        </p>

        <button type="submit" class="primary"
                style="width:100%; padding:12px; font-size:16px;">Register & Send OTP</button>
    </form>

    <!-- Step 2: OTP Verification Form -->
    <form id="otpForm" class="login-form" style="display:none;">
        <h2>Verify OTP</h2>

        <p>
            <input type="text" id="otp" name="otp" placeholder="Enter OTP" pattern="\d{6}" required
                   style="width:100%; padding:12px; font-size:16px; box-sizing:border-box;" />
        </p>

        <button type="submit" class="primary"
                style="width:100%; padding:12px; font-size:16px;">Verify OTP</button>
    </form>

    <div id="message"></div>
</div>

<script>
    // Step 1: Generate OTP
    document.getElementById('registerForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const phone = document.getElementById('phone_number').value.trim();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        const sid = document.getElementById('account_sid').value.trim();
        const auth = document.getElementById('auth_token').value.trim();

        // Save data temporarily for registration after OTP
        sessionStorage.setItem('username', username);
        sessionStorage.setItem('password', password);
        sessionStorage.setItem('phoneNumber', phone);
        sessionStorage.setItem('sid', sid);
        sessionStorage.setItem('auth', auth);

        // Call OTP generation endpoint
        const res = await fetch(`/otp/generate?phoneNumber=${encodeURIComponent(phone)}&sid=${encodeURIComponent(sid)}&auth=${encodeURIComponent(auth)}`);
        const text = await res.text();

        document.getElementById('message').innerText = text;

        // Show OTP form
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('otpForm').style.display = 'block';
    });

    // Step 2: Verify OTP
    document.getElementById('otpForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const otp = document.getElementById('otp').value.trim();
        const res = await fetch(`/otp/checker?otp=${encodeURIComponent(otp)}`, { method: 'POST' });
        const valid = await res.text();

        if (valid === 'true') {
            document.getElementById('message').innerText = "OTP Verified! Registration Complete.";

            // Register user after OTP verification
            await fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: sessionStorage.getItem('username'),
                    password: sessionStorage.getItem('password'),
                    phoneNumber: sessionStorage.getItem('phoneNumber'),
                    sid: sessionStorage.getItem('sid'),
                    auth: sessionStorage.getItem('auth')
                })
            });
        } else {
            document.getElementById('message').innerText = "Invalid or expired OTP.";
        }
    });
</script>
</body>
</html>
